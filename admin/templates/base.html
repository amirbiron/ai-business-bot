<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{{ business_name }} — פאנל ניהול</title>
    <!-- Google Fonts: Assistant (RTL optimized) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" crossorigin="anonymous">
    <!-- Design System CSS -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@2.0.4" crossorigin="anonymous"></script>
</head>
<body hx-headers='{"X-CSRFToken": "{{ csrf_token() }}"}'>
    <!-- Mobile Top Bar -->
    <div class="mobile-topbar">
        <button class="hamburger" onclick="toggleSidebar()" aria-label="תפריט">
            <i class="bi bi-list"></i>
        </button>
        <span class="brand-name">{{ business_name }}</span>
        <div style="width:32px"></div>
    </div>

    <!-- Sidebar Overlay (mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <div class="app-layout">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-brand">
                <div class="brand-icon"><i class="bi bi-robot"></i></div>
                <span class="brand-name">{{ business_name }}</span>
            </div>

            <ul class="sidebar-nav">
                <li>
                    <a href="/" class="{% if request.endpoint == 'dashboard' %}active{% endif %}">
                        <i class="bi bi-speedometer2"></i> לוח בקרה
                    </a>
                </li>
                <li>
                    <a href="/kb" class="{% if request.endpoint in ['kb_list', 'kb_add', 'kb_edit'] %}active{% endif %}">
                        <i class="bi bi-book"></i> בסיס ידע
                    </a>
                </li>
                <li>
                    <a href="/conversations" class="{% if request.endpoint in ['conversations', 'live_chat'] %}active{% endif %}">
                        <i class="bi bi-chat-dots"></i> שיחות
                        <span id="live-chat-badge" class="nav-badge" style="display:none;"></span>
                    </a>
                </li>
                <li>
                    <a href="/requests" class="{% if request.endpoint == 'agent_requests' %}active{% endif %}">
                        <i class="bi bi-bell"></i> בקשות נציג
                        <span id="request-badge" class="nav-badge" style="display:none;"></span>
                    </a>
                </li>
                <li>
                    <a href="/appointments" class="{% if request.endpoint == 'appointments' %}active{% endif %}">
                        <i class="bi bi-calendar-check"></i> תורים
                    </a>
                </li>
            </ul>

            <div class="sidebar-footer">
                <a href="/logout">
                    <i class="bi bi-box-arrow-right"></i> התנתקות
                </a>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Flash Messages -->
            <div id="flash-container">
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }}">
                    <span>{{ message }}</span>
                    <button class="btn-close" onclick="this.parentElement.remove()" aria-label="סגור">&times;</button>
                </div>
                {% endfor %}
            {% endif %}
            {% endwith %}
            </div>

            <div id="rag-stale-banner" class="rag-stale-warning" {% if not rag_index_stale %}style="display:none;"{% endif %}>
                <div>
                    <strong>האינדקס לא מעודכן.</strong>
                    שינוי בבסיס הידע עדיין לא משוקף בבוט — מומלץ לבנות מחדש את אינדקס ה‑RAG.
                </div>
                <form method="POST" action="/kb/rebuild">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-warning btn-sm"
                            onclick="return confirm('לבנות מחדש את אינדקס ה-RAG? זה עשוי לקחת רגע.')">
                        <i class="bi bi-arrow-clockwise"></i> בנייה מחדש
                    </button>
                </form>
            </div>

            {% block content %}{% endblock %}
        </main>
    </div>

    <script>
        // Sidebar toggle for mobile
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('active');
        }

        // Close sidebar on nav link click (mobile)
        document.querySelectorAll('.sidebar-nav a').forEach(function(link) {
            link.addEventListener('click', function() {
                if (window.innerWidth <= 768) {
                    toggleSidebar();
                }
            });
        });

        // Auto-update notification badges
        async function updateBadge() {
            try {
                var resp = await fetch('/api/stats');
                var data = await resp.json();
                var badge = document.getElementById('request-badge');
                if (data.pending_requests > 0) {
                    badge.textContent = data.pending_requests;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
                var liveBadge = document.getElementById('live-chat-badge');
                if (liveBadge) {
                    if (data.active_live_chats > 0) {
                        liveBadge.textContent = data.active_live_chats;
                        liveBadge.style.display = 'flex';
                    } else {
                        liveBadge.style.display = 'none';
                    }
                }
            } catch (e) {}
        }
        updateBadge();
        setInterval(updateBadge, 30000);

        // Auto-dismiss flash messages after 5s
        setTimeout(function() {
            document.querySelectorAll('#flash-container .alert').forEach(function(el) {
                el.style.opacity = '0';
                el.style.transition = 'opacity 0.3s ease';
                setTimeout(function() { el.remove(); }, 300);
            });
        }, 5000);

        // HTMX: show RAG stale warning after KB delete
        document.body.addEventListener('showStaleWarning', function() {
            var banner = document.getElementById('rag-stale-banner');
            if (banner) banner.style.display = '';
        });

        // HTMX: handle expired CSRF token
        document.body.addEventListener('csrfExpired', function() {
            alert('פג תוקף הטופס. יש לרענן את הדף ולנסות שוב.');
        });

        // HTMX: show toast notification from server-triggered events
        document.body.addEventListener('showToast', function(e) {
            var detail = e.detail || {};
            alert(detail.message || 'שגיאה לא צפויה.');
        });
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
